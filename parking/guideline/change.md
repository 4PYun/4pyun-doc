# 现金找零接入指引

## 现金找零

### 流程概述

1. 需要配置找零的车场联系平台研发配置开通找零功能，未开通配置的车场找零功能不可用，联系配置时需确定配置**找零订单过期时间**，订单过了该时间后不可再进行找零操作，未提供该过期时间则默认配置为**7天过期**
2. 该车场需登录**P云商户平台**进行商家钱包**预充值**，充值金额用于订单找零，若余额不足将导致找零失败
3. 车场需要通过**<u>推送车辆离场接口</u>**推送现金订单信息（含待找零金额）
4. 按照我们的找零链接生成规则拼接**找零链接**，提供找零链接给客户点点击进入找零页面进行找零（例如生成找零二维码）



### 关于商家钱包充值



### 关于现金订单推送

* 推送车辆离场接口详见[5.2 推送车辆离场](https://pptingche.coding.net/s/1885c509-dd3a-4606-82a0-27d3755a5bc7)

* 现金订单通过**<u>推送车辆离场接口</u>**的`payment_list`字段上传，该字段表示本次停车记录该车辆用户支付的订单集合，该集合中的订单参数结构如下：

| 字段名称 | 字段说明  |  类型  | 必填 | 示例 |
| :--- | :--- | :---: | :---: | :--- |
| pay_origin_desc | 微信      | string |  N   | 到账说明    |
| pay_type | 支付类型: 1现金, 2在线支付, 3无感支付, 4储值卡余额支付 | string |  N   | 2    |
| operator | 收费员    | string |  N   | 张三 |
| pay_time | 付款时间戳, 单位ms| string |  N   | 1572410847545|
| value    | 实收(不含优惠金额), 单位分      | string |  N   | 1572410847545|
| free_value      | 优惠金额, 单位分  | string |  N   | 1572410847545|
| parking_order   | 车场订单号必须唯一, 相同重复上报不受理   | string |  N   | PO201910301247278862|
| change_value    | 1572410847545     | string |  N   | 找零金额(=收现金总额 - 实收), 单位分, 仅现金缴费传递生效 |

* `pay_type`参数需传递现金类型，否则该订单不可找零
* `value`参数为该订单实际收取用户现金的金额（实收金额=订单金额+待找零金额）

* 该现金订单待找零的具体金额由`change_value`参数确定，找零金额单位为分

* `parking_order`为车场方自定义的订单号，后续生成找零链接需要传递该参数匹配找零订单


### 关于找零链接

* 链接地址

  ```
  https://qr.4pyun.com/parking?req=payment
  ```

* URL参数

| **参数**    | **必须** | **说明**   |
| --- | --- | --- |
| park_uuid   | Y | 平台分配的停车场ID |
| pay_partner | Y | 本地收费订单流水, 同上述现金订单信息中parking_order参数 |

* 示例

  ```
  https://qr.4pyun.com/parking?req=payment&park_uuid=49f0cc52-e8c7-41e3-b54d-af666b8cc11a&pay_partner=PO201910301247278862
  ```

* 说明

  对于每一笔找零订单需要拼接一个找零链接，可将该链接生成二维码给用户，在用户离场后扫码进行找零，用户进入找零订单页面后将显示该笔订单实付金额，以及待找零金额，车牌号等信息，该链接并不对用户进行身份校验，任何一个用户都可以点进链接进行找零，且仅限一次成功操作， 需提醒用户妥善保管该链接（二维码），找零金额将以微信红包形式通过平台微信公众号发送到用户微信
